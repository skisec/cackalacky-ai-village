# BITS Jobs (T1197)

## Description
Adversaries may abuse BITS jobs to persistently execute code and perform various background tasks. Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism exposed through Component Object Model (T1559.001) (COM). BITS is commonly used by updaters, messengers, and other applications preferred to operate in the background (using available idle bandwidth) without interrupting other networked applications. File transfer tasks are implemented as BITS jobs, which contain a queue of one or more file operations.

The interface to create and manage BITS jobs is accessible through PowerShell (T1059.001) and the BITSAdmin tool.

Adversaries may abuse BITS to download (e.g. Ingress Tool Transfer (T1105)), execute, and even clean up after running malicious code (e.g. Indicator Removal (T1070)). BITS tasks are self-contained in the BITS job database, without new files or registry modifications, and often permitted by host firewalls. BITS enabled execution may also enable persistence by creating long-standing jobs (the default maximum lifetime is 90 days and extendable) or invoking an arbitrary program when a job completes or errors (including after system reboots).

BITS upload functionalities can also be used to perform Exfiltration Over Alternative Protocol (T1048).

## Tactics
- Defense Evasion (TA0005)
- Persistence (TA0003)

## Related Groups
- Patchwork (G0040)
- Leviathan (G0065)
- APT39 (G0087)
- APT41 (G0096)
- Wizard Spider (G0102)

## Mitigations
- User Account Management (M1018)
- Filter Network Traffic (M1037)
- Operating System Configuration (M1028)

## Detection
BITS runs as a service and its status can be checked with the Sc query utility (```sc query bits```). Active BITS tasks can be enumerated using the BITSAdmin tool (```bitsadmin /list /allusers /verbose```).

Monitor usage of the BITSAdmin tool (especially the ‘Transfer’, 'Create', 'AddFile', 'SetNotifyFlags', 'SetNotifyCmdLine', 'SetMinRetryDelay', 'SetCustomHeaders', and 'Resume' command options) Admin logs, PowerShell logs, and the Windows Event log for BITS activity. Also consider investigating more detailed information about jobs by parsing the BITS job database.

Monitor and analyze network activity generated by BITS. BITS jobs use HTTP(S) and SMB for remote connections and are tethered to the creating user and will only function when that user is logged on (this rule applies even if a user attaches the job to a service account).

### Detailed Detection by Data Source/Component
#### Command: Command Execution (DS0017): 
Monitor executed commands and arguments from the BITSAdmin tool (especially the ‘Transfer’, 'Create', 'AddFile', 'SetNotifyFlags', 'SetNotifyCmdLine', 'SetMinRetryDelay', 'SetCustomHeaders', and 'Resume' command options) Admin logs, PowerShell logs, and the Windows Event log for BITS activity. Also consider investigating more detailed information about jobs by parsing the BITS job database.

#### Network Traffic: Network Connection Creation (DS0029): 
Monitor for newly constructed network activity generated by BITS. BITS jobs use HTTP(S) and SMB for remote connections and are tethered to the creating user and will only function when that user is logged on (this rule applies even if a user attaches the job to a service account).

#### Process: Process Creation (DS0009): 
Monitor for newly constructed BITS tasks to enumerate using the BITSAdmin tool (bitsadmin /list /allusers /verbose). 

Note: Event IDs are for Sysmon (Event ID 1 - process create) and Windows Security Log (Event ID 4688 - a new process has been created). Analytic 1 is oriented around looking for the creation of Microsoft Background Intelligent Transfer Service utility (bitsadmin.exe) processes that schedule a BITS job to persist on an endpoint. The analytic identifies the command-line parameters used to create, resume or add a file to a BITS job; these are typically seen combined in a single command-line or executed in sequence.

Analytic 2 identifies Microsoft Background Intelligent Transfer Service utility ``` bitsadmin.exe ``` using the ``` transfer``` parameter to download a remote object. In addition, look for ``` download ``` or ``` upload ``` on the command-line, the switches are not required to perform a transfer. Capture any files downloaded. Review the reputation of the IP or domain used. Typically once executed, a follow on command will be used to execute the dropped file. Network connection or file modification events related will not spawn or create from ``` bitsadmin.exe ```, but the artifacts will appear in a parallel process of ``` svchost.exe ``` with a command-line similar to ``` svchost.exe -k netsvcs -s BITS ```. It’s important to review all parallel and child processes to capture any behaviors and artifacts. In some suspicious and malicious instances, BITS jobs will be created. You can use ``` bitsadmin /list /verbose ``` to list out the jobs during investigation.


Analytic 1 - BITS Job Persistence

``` (source="*WinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode="1") OR (source="*WinEventLog:Security" EventCode="4688") Image="C:\Windows\System32\bitsadmin.exe" AND 
  (CommandLine= "*create*" OR
   CommandLine= "*addfile*" OR 
   CommandLine= "*setnotifyflags*" OR
   CommandLine= "*setnotifycmdline*" OR
   CommandLine= "*setminretrydelay*" OR 
   CommandLine= "*setcustomheaders*" OR
   CommandLine= "*resume*")```

Analytic 2 - BITSAdmin Download File

``` (source="*WinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode="1") OR (source="*WinEventLog:Security" EventCode="4688") Image="C:\Windows\System32\bitsadmin.exe" AND CommandLine= *transfer*```

#### Service: Service Metadata (DS0019): 
BITS runs as a service and its status can be checked with the Sc query utility (```sc query bits```).

